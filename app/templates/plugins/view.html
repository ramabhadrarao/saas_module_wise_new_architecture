{% extends 'layout/base.html' %}

{% block title %}Plugin: {{ plugin.name }}{% endblock %}

{% block page_title %}Plugin: {{ plugin.name }}{% endblock %}

{% block page_actions %}
<div class="btn-list">
    <a href="{{ url_for('plugins.index') }}" class="btn btn-outline-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M9 14l-4 -4l4 -4"></path>
            <path d="M5 10h11a4 4 0 1 1 0 8h-1"></path>
        </svg>
        Back to Plugins
    </a>
    
    {% if current_user.is_system_admin %}
    {% if plugin.status == 'inactive' or plugin.status == 'error' %}
    <form action="{{ url_for('plugins.activate', slug=plugin.slug) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-success">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M5 12l5 5l10 -10"></path>
            </svg>
            Activate Plugin
        </button>
    </form>
    {% elif plugin.status == 'active' %}
    <form action="{{ url_for('plugins.deactivate', slug=plugin.slug) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-warning">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M18 6l-12 12"></path>
                <path d="M6 6l12 12"></path>
            </svg>
            Deactivate Plugin
        </button>
    </form>
    {% endif %}
    {% endif %}
    
    {% if tenant and current_user.has_permission('install_plugin') %}
    {% if not tenant_plugin or not tenant_plugin.enabled %}
    <form action="{{ url_for('plugins.enable', slug=plugin.slug) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M12 5l0 14"></path>
                <path d="M5 12l14 0"></path>
            </svg>
            Enable for {{ tenant.name }}
        </button>
    </form>
    {% else %}
    <form action="{{ url_for('plugins.disable', slug=plugin.slug) }}" method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-danger">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path d="M18 6l-12 12"></path>
                <path d="M6 6l12 12"></path>
            </svg>
            Disable for {{ tenant.name }}
        </button>
    </form>
    {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="row row-cards">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Plugin Details</h3>
            </div>
            <div class="card-body">
                <div class="datagrid">
                    <div class="datagrid-item">
                        <div class="datagrid-title">Name</div>
                        <div class="datagrid-content">{{ plugin.name }}</div>
                    </div>
                    <div class="datagrid-item">
                        <div class="datagrid-title">Slug</div>
                        <div class="datagrid-content">{{ plugin.slug }}</div>
                    </div>
                    <div class="datagrid-item">
                        <div class="datagrid-title">Version</div>
                        <div class="datagrid-content">{{ plugin.version }}</div>
                    </div>
                    <div class="datagrid-item">
                        <div class="datagrid-title">Status</div>
                        <div class="datagrid-content">
                            {% if plugin.status == 'active' %}
                            <span class="badge bg-success">Active</span>
                            {% elif plugin.status == 'inactive' %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% elif plugin.status == 'pending' %}
                            <span class="badge bg-warning">Pending</span>
                            {% elif plugin.status == 'error' %}
                            <span class="badge bg-danger">Error</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="datagrid-item">
                        <div class="datagrid-title">Author</div>
                        <div class="datagrid-content">{{ plugin.author or 'Unknown' }}</div>
                    </div>
                    {% if plugin.homepage %}
                    <div class="datagrid-item">
                        <div class="datagrid-title">Homepage</div>
                        <div class="datagrid-content">
                            <a href="{{ plugin.homepage }}" target="_blank" rel="noopener noreferrer">{{ plugin.homepage }}</a>
                        </div>
                    </div>
                    {% endif %}
                    <div class="datagrid-item">
                        <div class="datagrid-title">System Plugin</div>
                        <div class="datagrid-content">
                            {% if plugin.is_system %}
                            <span class="badge bg-green">Yes</span>
                            {% else %}
                            <span class="badge bg-secondary">No</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="datagrid-item">
                        <div class="datagrid-title">Available to All Tenants</div>
                        <div class="datagrid-content">
                            {% if plugin.enabled_for_all %}
                            <span class="badge bg-green">Yes</span>
                            {% else %}
                            <span class="badge bg-secondary">No</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if current_user.is_system_admin %}
                    <div class="datagrid-item">
                        <div class="datagrid-title">Entry Point</div>
                        <div class="datagrid-content">
                            <code>{{ plugin.entry_point }}</code>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                {% if plugin.description %}
                <div class="mt-4">
                    <h4>Description</h4>
                    <p>{{ plugin.description }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    {% if tenant and tenant_plugin and tenant_plugin.enabled and plugin.status == 'active' %}
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Plugin Configuration</h3>
                {% if current_user.has_permission('configure_plugin') %}
                <div class="card-actions">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#configModal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"></path>
                            <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z"></path>
                            <path d="M16 5l3 3"></path>
                        </svg>
                        Edit Config
                    </button>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if tenant_plugin.config %}
                <div class="config-display">
                    <pre id="configDisplay">{{ tenant_plugin.config | tojson(indent=4) }}</pre>
                </div>
                {% else %}
                <div class="empty">
                    <p class="empty-title">No configuration</p>
                    <p class="empty-subtitle text-muted">
                        This plugin has no custom configuration.
                    </p>
                    {% if current_user.has_permission('configure_plugin') %}
                    <div class="empty-action">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#configModal">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1"></path>
                                <path d="M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z"></path>
                                <path d="M16 5l3 3"></path>
                            </svg>
                            Add Configuration
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Configuration Modal -->
    <!-- Update the configuration modal section -->
<div class="modal modal-blur fade" id="configModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Plugin Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="configForm" method="post" action="{{ url_for('plugin_api.update_tenant_plugin_config', plugin_slug=plugin.slug) }}">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label class="form-label">Configuration (JSON)</label>
                        <textarea id="configEditor" name="config" class="form-control json-editor" rows="10">{{ tenant_plugin.config | tojson(indent=4) if tenant_plugin and tenant_plugin.config else '{}' }}</textarea>
                        <div class="invalid-feedback" id="configError"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save configuration</button>
                </div>
            </form>
        </div>
    </div>
</div>
    {% endif %}
</div>
{% endblock %}
<!-- Add this section to the plugins/view.html template -->

<!-- Add this after the existing card sections -->
{% if current_user.is_system_admin and plugin.status == 'active' %}
<div class="col-md-6">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Tenant Assignment</h3>
        </div>
        <div class="card-body">
            {% if plugin.enabled_for_all %}
            <div class="alert alert-info">
                <div class="d-flex">
                    <div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon alert-icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <path d="M12 9h.01"></path>
                            <path d="M11 12h1v4h1"></path>
                            <path d="M12 3c7.2 0 9 1.8 9 9s-1.8 9 -9 9s-9 -1.8 -9 -9s1.8 -9 9 -9z"></path>
                        </svg>
                    </div>
                    <div>
                        <h4 class="alert-title">This plugin is enabled for all tenants</h4>
                        <div class="text-muted">Every tenant can use this plugin without explicit assignment</div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="mb-3">
                <h4>Assigned Tenants</h4>
                {% for tenant_id in enabled_tenant_ids %}
                    {% for tenant in tenants %}
                        {% if tenant.id == tenant_id %}
                        <span class="badge bg-blue me-1 mb-1">{{ tenant.name }}</span>
                        {% endif %}
                    {% endfor %}
                {% else %}
                <span class="text-muted">No tenants assigned yet</span>
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="d-flex">
                <a href="{{ url_for('plugins.assign_tenants', slug=plugin.slug) }}" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M9 11l3 3l8 -8"></path>
                        <path d="M20 12v6a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h9"></path>
                    </svg>
                    Manage Tenant Assignments
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Add this at the end of the content block if you want the debug section -->
{% if current_user.is_system_admin %}
<div class="col-12">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Debug Information</h3>
            <div class="card-actions">
                <a href="#" data-bs-toggle="collapse" data-bs-target="#debugContent" class="btn btn-outline-secondary btn-sm">
                    Toggle Debug Info
                </a>
            </div>
        </div>
        <div class="card-body collapse" id="debugContent">
            <pre>{{ plugin_debug | tojson(indent=4) }}</pre>
        </div>
    </div>
</div>
{% endif %}
{% block extra_js %}
{% if tenant and tenant_plugin and tenant_plugin.enabled and plugin.status == 'active' and current_user.has_permission('configure_plugin') %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const saveConfigBtn = document.getElementById('saveConfig');
        const configEditor = document.getElementById('configEditor');
        const configError = document.getElementById('configError');
        const configDisplay = document.getElementById('configDisplay');
        
        saveConfigBtn.addEventListener('click', function() {
            // Validate JSON
            let config;
            try {
                config = JSON.parse(configEditor.value);
                configEditor.classList.remove('is-invalid');
                configError.textContent = '';
            } catch (e) {
                configEditor.classList.add('is-invalid');
                configError.textContent = 'Invalid JSON: ' + e.message;
                return;
            }
            
            // Send API request to update configuration
            fetch('{{ url_for("plugin_api.update_tenant_plugin_config", plugin_slug=plugin.slug) }}', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update configuration display
                    configDisplay.textContent = JSON.stringify(config, null, 4);
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('configModal'));
                    modal.hide();
                    
                    // Show success message
                    app.showNotification(data.message, 'success');
                } else {
                    // Show error message
                    configEditor.classList.add('is-invalid');
                    configError.textContent = data.message;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                configEditor.classList.add('is-invalid');
                configError.textContent = 'An error occurred while saving configuration';
            });
        });
    });


    
</script>
{% endif %}
{% endblock %}